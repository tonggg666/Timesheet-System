<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ ä¸“ä¸šå·¥æ—¶è®°å½•ç³»ç»Ÿ V4.1 (å‘˜å·¥ç®¡ç†)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- é¢œè‰²ä¸å˜é‡å®šä¹‰ --- */
        :root {
            --primary-color: #3F51B5; /* æ·±è“è‰²/é›è“è‰² */
            --primary-light: #5C6BC0;
            --secondary-color: #FFC107; /* å¼ºè°ƒè‰²/è­¦å‘Šè‰² */
            --success-color: #4CAF50; /* ç»¿è‰² */
            --danger-color: #F44336; /* çº¢è‰²ç”¨äºåˆ é™¤ */
            --background-start: #E0F7FA; 
            --background-end: #F0F4C3; 
            --card-bg: #FFFFFF;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.15); 
        }
        
        /* --- å…¨å±€æ ·å¼å’ŒèƒŒæ™¯ --- */
        body { 
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            margin: 0; 
            padding: 40px 20px; 
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* --- ä¸»å®¹å™¨å’Œæ ‡é¢˜ --- */
        .container { 
            max-width: 950px; 
            margin: 0 auto; 
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: var(--shadow-card); 
            transition: all 0.3s ease;
        }
        h2 { 
            color: var(--primary-color); 
            font-weight: 700;
            border-bottom: 4px solid var(--secondary-color); 
            padding-bottom: 15px; 
            margin-bottom: 35px; 
            text-align: center; 
            letter-spacing: 1px;
        }
        h3 {
            color: var(--primary-light);
            font-weight: 500;
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin-bottom: 25px;
        }
        
        /* --- åŒºå—æ ·å¼ --- */
        .section { 
            margin-bottom: 40px; 
            padding: 30px; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            background-color: #f7f9fc; 
            box-shadow: var(--shadow-subtle);
            transition: box-shadow 0.3s;
        }
        
        /* --- æŒ‰é’®æ ·å¼ --- */
        .button { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            color: white; 
            font-weight: 500;
            transition: all 0.2s ease-in-out; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 150px;
        }
        .button-small {
            padding: 6px 12px;
            min-width: unset;
            font-size: 0.9em;
            border-radius: 6px;
        }
        .button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .button-primary { background-color: var(--primary-color); }
        .button-success { background-color: var(--success-color); }
        .button-danger { background-color: var(--danger-color); }
        
        /* --- è¾“å…¥æ¡†æ ·å¼ --- */
        .input-group { 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 15px; 
        }
        .input-group input[type="text"], 
        .input-group input[type="date"] { 
            padding: 10px 12px; 
            border: 1px solid #bdbdbd; 
            border-radius: 8px; 
            flex-grow: 1; 
            min-width: 150px;
        }
        
        /* --- è¡¨æ ¼æ ·å¼ (é€šç”¨å’Œå‘˜å·¥ç®¡ç†) --- */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            margin-top: 25px; 
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        /* ç®¡ç†åˆ—è¡¨ä¸­çš„æ“ä½œåˆ— */
        #worker-management-table td:last-child { 
            text-align: right; 
            min-width: 150px;
        }

        th, td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eeeeee;
        }
        th { 
            background-color: #f1f2f6; 
            font-weight: 700;
            color: #333;
        }
        tr:hover td:not(.no-hover) { background-color: #e3f2fd; } 

        .input-hours { 
            width: 70px; 
            text-align: center;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* --- æ¶ˆæ¯å’ŒçŠ¶æ€æ ·å¼ --- */
        .message { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: 500; 
            opacity: 0; 
            transition: all 0.5s ease-out;
            transform: translateY(10px);
        }
        .message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message.success { background-color: #e8f5e9; color: var(--success-color); border: 1px solid #c8e6c9; }
        .message.error { background-color: #ffebee; color: #D32F2F; border: 1px solid #ffcdd2; }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            background-color: var(--secondary-color);
            color: #333;
            margin-left: 10px;
        }

        /* --- æ¨¡æ€æ¡† (Modal) æ ¸å¿ƒæ ·å¼ --- */
        .modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto; /* å±…ä¸­æ˜¾ç¤º */
            padding: 30px;
            border-radius: 12px;
            width: 90%; 
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.4s ease-out;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 36px;
            font-weight: bold;
            transition: 0.3s;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--danger-color);
            text-decoration: none;
            cursor: pointer;
        }
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- åŠ è½½åŠ¨ç”» --- */
        @keyframes spinner { to { transform: rotate(360deg); } }
        .spinner {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner 0.75s linear infinite;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>â±ï¸ ä¸“ä¸šå·¥æ—¶è®°å½•ä¸å¯¼å‡ºç³»ç»Ÿ V4.1</h2>
    <p style="text-align: center; color: #757575;">ç³»ç»Ÿä½¿ç”¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®å®‰å…¨ä¸”å¯ç¦»çº¿æ“ä½œã€‚æ•°æ®ä¸ä¼šè¢«è¯¯åˆ ã€‚</p>

    <div class="section">
        <h3>1ï¸âƒ£ å‘˜å·¥ä¿¡æ¯å»ºæ¡£ä¸ç®¡ç†</h3>
        <span class="status-badge" id="worker-count-badge">0 äººå·²å»ºæ¡£</span>
        <p>åœ¨æ­¤å½•å…¥æˆ–ä¿®æ”¹å‘˜å·¥æ¡£æ¡ˆã€‚ä¿®æ”¹åè¯·ç‚¹å‡»ä¸‹æ–¹çš„**â€œæ›´æ–°â€**æŒ‰é’®ã€‚</p>
        
        <div id="new-worker-form">
            <div class="input-group">
                <label>å·¥å· ID:</label><input type="text" id="input-id" placeholder="å¿…å¡«ï¼Œç”¨äºå”¯ä¸€è¯†åˆ«" required>
                <label>å§“å:</label><input type="text" id="input-name" placeholder="å¿…å¡«ï¼Œå‘˜å·¥å§“å" required>
            </div>
            <div class="input-group">
                <label>å…¬å¸:</label><input type="text" id="input-company" placeholder="æ‰€å±å…¬å¸/éƒ¨é—¨">
                <label>å·¥ç§:</label><input type="text" id="input-job" placeholder="å…·ä½“å·¥ç§/å²—ä½">
            </div>
            <button class="button button-primary" id="add-worker-btn" onclick="addWorkerMetadata()">
                â• æ·»åŠ  / æ›´æ–°å‘˜å·¥ä¿¡æ¯
            </button>
            <button class="button button-primary" style="margin-left: 20px; background-color: #00bcd4;" onclick="openWorkerManagementModal()">
                âš™ï¸ ç®¡ç†å‘˜å·¥æ¡£æ¡ˆ
            </button>
            <p id="metadata-message" class="message"></p>
        </div>
    </div>

    <div class="section">
        <h3>2ï¸âƒ£ æ‰¹é‡å·¥æ—¶å½•å…¥ (æ¯æ—¥å·¥ä½œ)</h3>
        <div class="input-group">
            <label for="work-date">é€‰æ‹©å½•å…¥æ—¥æœŸ:</label>
            <input type="date" id="work-date" value="">
            <button class="button button-primary" id="load-workers-btn" onclick="loadWorkersForInput()">
                ğŸ“‹ åŠ è½½æ‰€æœ‰å·²å»ºæ¡£å‘˜å·¥åå•
            </button>
        </div>
        
        <div id="input-area" style="display: none;">
            <h4>æ­£åœ¨å½•å…¥æ—¥æœŸ: <span id="current-date-display" style="color: var(--primary-color);"></span></h4>
            <table id="time-input-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å·¥å·</th>
                        <th>å·¥ç§</th>
                        <th>å·¥æ—¶ (å°æ—¶)</th>
                    </tr>
                </thead>
                <tbody id="worker-list-body">
                    </tbody>
            </table>
            <button class="button button-success" id="submit-time-btn" onclick="submitTimeRecords()" style="width: 100%; margin-top: 25px;">
                ğŸ’¾ æäº¤å¹¶ä¿å­˜å½“æ—¥å·¥æ—¶ (è‡ªåŠ¨è¦†ç›–æ—§è®°å½•)
            </button>
            <p id="submit-message" class="message"></p>
        </div>
    </div>

    <div class="section">
        <h3>3ï¸âƒ£ æŠ¥è¡¨å¯¼å‡º (æœˆåº¦æ€»ç»“)</h3>
        <p>ç‚¹å‡»æŒ‰é’®å¯¼å‡ºåŒ…å«å½“æœˆæ‰€æœ‰å·¥æ—¶æ•°æ®çš„ Excel æŠ¥è¡¨ã€‚</p>
        <button class="button button-primary" id="generate-report-btn" onclick="generateReport()">
            ğŸ“Š ä¸€é”®ç”Ÿæˆå¹¶ä¸‹è½½æœ¬æœˆæŠ¥è¡¨
        </button>
        <p id="report-message" class="message"></p>
    </div>
</div>

<div id="workerManagementModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeWorkerManagementModal()">&times;</span>
        <h3>ğŸ“š å‘˜å·¥æ¡£æ¡ˆç®¡ç†åˆ—è¡¨</h3>
        <p>ç‚¹å‡» **ç¼–è¾‘** å°†ä¿¡æ¯åŠ è½½åˆ°ä¸»é¡µé¢çš„è¾“å…¥æ¡†è¿›è¡Œä¿®æ”¹ã€‚</p>
        <div style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
            <table id="worker-management-table">
                <thead>
                    <tr>
                        <th>å§“å (å·¥ç§)</th>
                        <th>å·¥å· ID</th>
                        <th>å…¬å¸åç§°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="worker-management-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    const STORAGE_KEY_LOGS = 'timesheetLogs_Manual';
    const STORAGE_KEY_METADATA = 'employeeMetadata_Manual'; 
    let timeLogs = [];
    let employeeMetadata = {}; 

    // --- åˆå§‹åŒ–å’ŒåŠ è½½æ•°æ® ---
    function init() {
        timeLogs = JSON.parse(localStorage.getItem(STORAGE_KEY_LOGS) || '[]');
        employeeMetadata = JSON.parse(localStorage.getItem(STORAGE_KEY_METADATA) || '{}');
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('work-date').value = today;
        updateWorkerCountBadge();
    }

    function updateWorkerCountBadge() {
        // ID ä¿æŒä¸å˜ï¼Œä½†å†…å®¹æ›´æ–°ä¸ºâ€œå‘˜å·¥â€
        document.getElementById('worker-count-badge').textContent = `${Object.keys(employeeMetadata).length} äººå·²å»ºæ¡£`;
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šæ¶ˆæ¯æ˜¾ç¤ºå’ŒæŒ‰é’®åŠ è½½çŠ¶æ€ ---
    function showMessage(elementId, type, text) {
        const el = document.getElementById(elementId);
        if (!el) return;
        
        el.className = `message ${type}`;
        el.textContent = text;
        void el.offsetWidth;
        el.classList.add('show');
        
        setTimeout(() => {
            el.classList.remove('show');
        }, 5000); 
    }
    
    function setButtonLoading(id, isLoading, originalText = null) {
        const btn = document.getElementById(id);
        if (!btn) return;
        
        if (isLoading) {
            btn.setAttribute('data-original-text', btn.innerHTML);
            btn.innerHTML = originalText || 'å¤„ç†ä¸­...';
            btn.disabled = true;
            btn.innerHTML += `<span class="spinner"></span>`;
        } else {
            const html = btn.getAttribute('data-original-text') || originalText || '';
            btn.innerHTML = html;
            btn.disabled = false;
        }
    }

    // --- 1. å‘˜å·¥å»ºæ¡£/æ›´æ–° ---
    function addWorkerMetadata() {
        setButtonLoading('add-worker-btn', true, 'æ­£åœ¨ä¿å­˜...');
        const id = document.getElementById('input-id').value.trim();
        const name = document.getElementById('input-name').value.trim();
        const company = document.getElementById('input-company').value.trim();
        const job = document.getElementById('input-job').value.trim();
        
        if (!id || !name) {
            showMessage('metadata-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šå·¥å· (ID) å’Œå§“åå¿…é¡»å¡«å†™ï¼');
            setButtonLoading('add-worker-btn', false, 'â• æ·»åŠ  / æ›´æ–°å‘˜å·¥ä¿¡æ¯');
            return;
        }
        
        setTimeout(() => { 
            const newWorker = {
                employee_id: id,
                name: name,
                company_name: company,
                job_type: job,
            };
            
            const isNew = !employeeMetadata[id];
            employeeMetadata[id] = newWorker;
            localStorage.setItem(STORAGE_KEY_METADATA, JSON.stringify(employeeMetadata));

            // ä¸­æ–‡æç¤ºæ›´æ–°
            showMessage('metadata-message', 'success', `âœ… å‘˜å·¥ **${name}** (ID: ${id}) çš„ä¿¡æ¯å·²${isNew ? 'æ·»åŠ ' : 'æ›´æ–°'}æˆåŠŸï¼`);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('input-name').value = '';
            document.getElementById('input-company').value = '';
            document.getElementById('input-job').value = '';
            document.getElementById('input-id').focus();
            setButtonLoading('add-worker-btn', false, 'â• æ·»åŠ  / æ›´æ–°å‘˜å·¥ä¿¡æ¯');
            
            updateWorkerCountBadge(); 
            if (document.getElementById('workerManagementModal').style.display === 'block') {
                renderWorkerManagementTable(); 
            }

        }, 300);
    }
    
    // --- 1.1 å‘˜å·¥ç®¡ç†æ¨¡æ€æ¡†æ§åˆ¶ ---
    function openWorkerManagementModal() {
        renderWorkerManagementTable();
        document.getElementById('workerManagementModal').style.display = 'block';
    }

    function closeWorkerManagementModal() {
        document.getElementById('workerManagementModal').style.display = 'none';
    }

    // åœ¨çª—å£å¤–éƒ¨ç‚¹å‡»æ—¶å…³é—­æ¨¡æ€æ¡†
    window.onclick = function(event) {
        const modal = document.getElementById('workerManagementModal');
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }

    // --- 1.2 å‘˜å·¥ç®¡ç†åˆ—è¡¨æ¸²æŸ“ ---
    function renderWorkerManagementTable() {
        const tableBody = document.getElementById('worker-management-body');
        tableBody.innerHTML = '';
        
        const workersArray = Object.values(employeeMetadata).sort((a, b) => a.employee_id.localeCompare(b.employee_id));

        if (workersArray.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #757575;">æš‚æ— å·²å»ºæ¡£å‘˜å·¥ä¿¡æ¯ã€‚</td></tr>';
            return;
        }

        workersArray.forEach(worker => {
            const row = tableBody.insertRow();
            
            row.innerHTML = `
                <td>${worker.name} (${worker.job_type || 'æœªå®šä¹‰'})</td>
                <td>${worker.employee_id}</td>
                <td>${worker.company_name || 'æœªå®šä¹‰'}</td>
                <td class="no-hover">
                    <button class="button button-primary button-small" onclick="loadWorkerForEdit('${worker.employee_id}')">
                        âœï¸ ç¼–è¾‘
                    </button>
                    <button class="button button-danger button-small" style="margin-left: 5px;" onclick="confirmDeleteWorker('${worker.employee_id}', '${worker.name}')">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </td>
            `;
        });
    }

    // --- 1.3 åŠ è½½å‘˜å·¥ä¿¡æ¯åˆ°è¾“å…¥æ¡† (Edit) ---
    window.loadWorkerForEdit = function(id) {
        const worker = employeeMetadata[id];
        if (!worker) {
            showMessage('metadata-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°è¯¥å·¥å·çš„æ¡£æ¡ˆã€‚');
            return;
        }
        
        // 1. å¡«å……åˆ°ä¸»é¡µé¢è¡¨å•
        document.getElementById('input-id').value = worker.employee_id;
        document.getElementById('input-name').value = worker.name;
        document.getElementById('input-company').value = worker.company_name;
        document.getElementById('input-job').value = worker.job_type;
        document.getElementById('input-id').focus();
        
        // 2. å…³é—­æ¨¡æ€æ¡†
        closeWorkerManagementModal();

        // 3. ç»™å‡ºæç¤ºå¹¶æ»šåŠ¨åˆ°é¡¶éƒ¨
        // ä¸­æ–‡æç¤ºæ›´æ–°
        showMessage('metadata-message', 'success', `âœ… å·²åŠ è½½å‘˜å·¥ **${worker.name}** çš„ä¿¡æ¯åˆ°ä¸Šæ–¹ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»â€œæ›´æ–°â€ã€‚`);
        window.scrollTo(0, 0); 
    }

    // --- 1.4 ç¡®è®¤å¹¶åˆ é™¤å‘˜å·¥ä¿¡æ¯ (å·²ä¿®å¤ä¸ºå…¨å±€å‡½æ•°) ---
    window.confirmDeleteWorker = function(id, name) {
        // ä¸­æ–‡æç¤ºæ›´æ–°
        if (confirm(`âš ï¸ è­¦å‘Šï¼æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å‘˜å·¥ã€${name} (ID: ${id})ã€‘çš„æ¡£æ¡ˆå—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤æ¡£æ¡ˆå¹¶ä¸ä¼šåˆ é™¤è¯¥å‘˜å·¥å·²ç»å½•å…¥çš„å·¥æ—¶è®°å½•ã€‚`)) {
            deleteWorker(id, name);
        }
    }
    
    function deleteWorker(id, name) {
        if (employeeMetadata[id]) {
            delete employeeMetadata[id];
            localStorage.setItem(STORAGE_KEY_METADATA, JSON.stringify(employeeMetadata));
            renderWorkerManagementTable();
            updateWorkerCountBadge();
            // ä¸­æ–‡æç¤ºæ›´æ–°
            showMessage('metadata-message', 'success', `ğŸ—‘ï¸ æˆåŠŸåˆ é™¤å‘˜å·¥ **${name}** çš„æ¡£æ¡ˆã€‚`);
        } else {
            showMessage('metadata-message', 'error', `â›”ï¸ é”™è¯¯ï¼šåˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°å·¥å· ${id} çš„æ¡£æ¡ˆã€‚`);
        }
    }
    // --- å‘˜å·¥ç®¡ç†æ¨¡å—ç»“æŸ ---


    // --- 2. åŠ è½½å’Œå½•å…¥å·¥æ—¶ ---
    function loadWorkersForInput() {
        setButtonLoading('load-workers-btn', true, 'æ­£åœ¨åŠ è½½...');
        const date = document.getElementById('work-date').value;
        
        if (Object.keys(employeeMetadata).length === 0) {
            // ä¸­æ–‡æç¤ºæ›´æ–°
            showMessage('submit-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šè¯·å…ˆåœ¨ç¬¬ 1 èŠ‚æ·»åŠ å‘˜å·¥ä¿¡æ¯æ‰èƒ½å½•å…¥ï¼');
            setButtonLoading('load-workers-btn', false, 'ğŸ“‹ åŠ è½½æ‰€æœ‰å·²å»ºæ¡£å‘˜å·¥åå•');
            return;
        }
        if (!date) {
            showMessage('submit-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šè¯·é€‰æ‹©å½•å…¥æ—¥æœŸï¼');
            setButtonLoading('load-workers-btn', false, 'ğŸ“‹ åŠ è½½æ‰€æœ‰å·²å»ºæ¡£å‘˜å·¥åå•');
            return;
        }
        
        setTimeout(() => { 
            document.getElementById('current-date-display').textContent = date;
            document.getElementById('input-area').style.display = 'block';

            const workersArray = Object.values(employeeMetadata).sort((a, b) => a.employee_id.localeCompare(b.employee_id));
            renderWorkerInputTable(workersArray, date);
            
            // ä¸­æ–‡æç¤ºæ›´æ–°
            showMessage('submit-message', 'success', `âœ… å·²åŠ è½½ ${workersArray.length} åå‘˜å·¥åå•ï¼Œè¯·å¡«å†™ ${date} çš„å·¥æ—¶ã€‚`);
            setButtonLoading('load-workers-btn', false, 'ğŸ“‹ åŠ è½½æ‰€æœ‰å·²å»ºæ¡£å‘˜å·¥åå•');
            
        }, 500);
    }

    function renderWorkerInputTable(workers, date) {
        const tableBody = document.getElementById('worker-list-body');
        tableBody.innerHTML = '';
        
        const existingLogs = timeLogs.filter(log => log.work_date === date);
        const logMap = new Map(existingLogs.map(log => [log.employee_id, log.hours_manual]));

        workers.forEach(worker => {
            const row = tableBody.insertRow();
            const existingHours = logMap.get(worker.employee_id) || ''; 
            
            row.innerHTML = `
                <td>${worker.name}</td>
                <td>${worker.employee_id}</td>
                <td>${worker.job_type}</td>
                <td><input type="number" class="input-hours" min="0" max="24" step="0.5" value="${existingHours}" data-id="${worker.employee_id}" onfocus="this.select()"></td>
            `;
        });
        
        const firstInput = document.querySelector('#worker-list-body .input-hours');
        if (firstInput) {
            firstInput.focus();
        }
    }
    
    function submitTimeRecords() {
        setButtonLoading('submit-time-btn', true, 'æ­£åœ¨ä¿å­˜...');
        const date = document.getElementById('work-date').value;

        const inputs = document.querySelectorAll('#worker-list-body .input-hours');
        
        if (inputs.length === 0) {
             // ä¸­æ–‡æç¤ºæ›´æ–°
             showMessage('submit-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šè¯·å…ˆåŠ è½½å‘˜å·¥åå•ã€‚');
            setButtonLoading('submit-time-btn', false, 'ğŸ’¾ æäº¤å¹¶ä¿å­˜å½“æ—¥å·¥æ—¶ (è‡ªåŠ¨è¦†ç›–æ—§è®°å½•)');
            return;
        }
        
        // 1. è¿‡æ»¤æ‰å½“å¤©æ‰€æœ‰æ—§è®°å½• (è¦†ç›–é€»è¾‘)
        timeLogs = timeLogs.filter(log => log.work_date !== date);
        
        // 2. æ’å…¥æ–°è®°å½•
        const newLogs = [];
        inputs.forEach(input => {
            const employeeId = input.dataset.id;
            const hours = parseFloat(input.value) || 0;
            
            if (hours > 0) {
                newLogs.push({
                    employee_id: employeeId,
                    work_date: date,
                    hours_manual: hours,
                    timestamp: new Date().toISOString()
                });
            }
        });

        setTimeout(() => { 
            if (newLogs.length === 0) {
                showMessage('submit-message', 'error', `âš ï¸ æ³¨æ„ï¼š${date} å·²ä¿å­˜æˆåŠŸï¼Œä½†æ²¡æœ‰æœ‰æ•ˆå·¥æ—¶è®°å½• (>0 å°æ—¶) æäº¤ã€‚`);
                localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(timeLogs)); 
                setButtonLoading('submit-time-btn', false, 'ğŸ’¾ æäº¤å¹¶ä¿å­˜å½“æ—¥å·¥æ—¶ (è‡ªåŠ¨è¦†ç›–æ—§è®°å½•)');
                return;
            }

            timeLogs.push(...newLogs);
            localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(timeLogs));

            showMessage('submit-message', 'success', `ğŸ‰ æˆåŠŸï¼${date} å½“å¤© ${newLogs.length} æ¡æœ‰æ•ˆå·¥æ—¶è®°å½•å·²ä¿å­˜å¹¶è¦†ç›–ä¹‹å‰çš„è®°å½•ï¼`);
            setButtonLoading('submit-time-btn', false, 'ğŸ’¾ æäº¤å¹¶ä¿å­˜å½“æ—¥å·¥æ—¶ (è‡ªåŠ¨è¦†ç›–æ—§è®°å½•)');
        }, 800);
    }

    // --- 3. æŠ¥è¡¨å¯¼å‡º ---
    function generateReport() {
        setButtonLoading('generate-report-btn', true, 'æ­£åœ¨ç”Ÿæˆ...');
        
        if (typeof XLSX === 'undefined') {
            alert("é”™è¯¯ï¼šExcel å¤„ç†åº“æœªåŠ è½½ã€‚è¯·å°è¯•è¿æ¥ç½‘ç»œæˆ–ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨æ‰“å¼€æ­¤æ–‡ä»¶ã€‚");
            setButtonLoading('generate-report-btn', false, 'ğŸ“Š ä¸€é”®ç”Ÿæˆå¹¶ä¸‹è½½æœ¬æœˆæŠ¥è¡¨');
            return;
        }
        
        if (timeLogs.length === 0) {
            showMessage('report-message', 'error', 'â›”ï¸ é”™è¯¯ï¼šæ²¡æœ‰å·¥æ—¶è®°å½•å¯ä»¥å¯¼å‡ºã€‚');
            setButtonLoading('generate-report-btn', false, 'ğŸ“Š ä¸€é”®ç”Ÿæˆå¹¶ä¸‹è½½æœ¬æœˆæŠ¥è¡¨');
            return;
        }
        
        setTimeout(() => { 
            const dataForReport = [];
            const monthYear = new Date().toISOString().substring(0, 7); 
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const allEmployeesIds = Object.keys(employeeMetadata);
            const dailyHoursMap = {}; 
            
            allEmployeesIds.forEach(id => {
                const meta = employeeMetadata[id];
                if (meta) {
                    dailyHoursMap[id] = { ...meta, employee_id: id, total_hours: 0, daily: {} };
                }
            });

            timeLogs.forEach(log => {
                const key = log.employee_id;
                if (log.work_date.startsWith(monthYear) && dailyHoursMap[key]) {
                    const hours = log.hours_manual;
                    dailyHoursMap[key].daily[log.work_date] = hours; 
                    dailyHoursMap[key].total_hours += hours;
                }
            });

            const headers = ['å·¥å·/ID', 'å§“å/Name', 'å…¬å¸/Company', 'å·¥ç§/Job'];
            for (let day = 1; day <= daysInMonth; day++) {
                headers.push(day.toString());
            }
            headers.push('æœˆæ€»å·¥æ—¶ (Hrs)');
            dataForReport.push(headers);

            Object.values(dailyHoursMap)
                .filter(item => item.total_hours > 0) 
                .sort((a, b) => a.employee_id.localeCompare(b.employee_id))
                .forEach(item => {

                const row = [
                    item.employee_id,
                    item.name,
                    item.company_name,
                    item.job_type,
                ];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayString = day.toString().padStart(2, '0');
                    const fullDate = `${monthYear}-${dayString}`;
                    const hours = item.daily[fullDate] || 0;
                    row.push(hours > 0 ? hours : ''); 
                }
                
                row.push(item.total_hours.toFixed(1));
                dataForReport.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(dataForReport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Timesheet_Detail");
            
            const filename = `Timesheet_Report_${monthYear}.xlsx`;
            XLSX.writeFile(wb, filename);

            showMessage('report-message', 'success', `ğŸ‰ æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼æ–‡ä»¶ **${filename}** å·²ä¸‹è½½ã€‚`);
            setButtonLoading('generate-report-btn', false, 'ğŸ“Š ä¸€é”®ç”Ÿæˆå¹¶ä¸‹è½½æœ¬æœˆæŠ¥è¡¨');

        }, 1000);
    }
    
    // å¯åŠ¨åº”ç”¨
    init();
</script>
</body>
</html>